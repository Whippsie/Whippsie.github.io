<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="styles/style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="./scripts/files.js"></script>
<script src="./scripts/objects.js"></script>
<script src="./scripts/parsing.js"></script>
<script>
var pathJar="E:\\Ducky_Genie\\canardrunnable.jar";
var nameConfigFile="myConfig";

function readFile (fullpath){
	var result="";
	$.ajax({
		url: fullpath,
		async: false,
		dataType: "text",
		success: function (data) {
			result = data;
		}
	});
	return result;
}

function eraseColorRadio(){
	$('label').each(function() {
		jQuery(this).removeClass('incorrect');
		jQuery(this).removeClass('missing');
		jQuery(this).removeClass('titleNotice');
		jQuery(this).addClass('normal');
	});
}
function prepDemoDict(){
	var selected = $('#demo_files').val();
	var dataDemo = readFile("demos/"+selected+".launch");
	var dictDemo = rosToDict(dataDemo);
	return dictDemo;
}

function prepConfigDict(){
	//parsetoROS ('ConfigUser');
	//var dataUser = readFile("ConfigUser.launch");
	var dictUser = rosToDict(dataUser);
	return dictUser;
}

function callJavaApp(){
	var url = '/call-java-app';
	console.log(url);
	var xmlHttp = new XMLHttpRequest();

	xmlHttp.onreadystatechange = function () {
		if (xmlHttp.readyState === 4) {
			var test = xmlHttp.responseText;
			console.log(test);
		}
	}
	xmlHttp.open("POST", url, true); // false for synchronous request
	xmlHttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	xmlHttp.send('location="'+pathJar+'"&nameConfigFile='+nameConfigFile);

}
function loadMenuEvents(){
	$('#menuLoadSeeConfig').click(function() {loadSeeConfig(); return false; });
	$('#menuGenerateConfig').click(function() {parsetoROS(nameConfigFile); return false; });
	$('#menuCompareConfig').click(function() {showCompareUI(); return false; });
	$('#menuCallJavaApp').click(function() {callJavaApp(); return false; });
	$('#menuSetupConfig').click(function() {setupShow(); return false; });
}

function rosToJava(){
	hideAll();
	var dictUser = rosToDict(dataUser);
	dictToJava(dictUser);
}

function triggerLoad(){
	loadFileAsText();
	//Call the next step if file is loaded successfully
	//if (dataUser != ""){

	//}
}

function loadSeeConfig(){
	if (lastclicked == "load"){
		$("#loadSeeConfig").toggle("blind");
	}else{
		hideAll();
		lastclicked="load";
		loadSeeConfig();
	}
}

var lastclicked = "setup";

function hideAll(){
	$('#legendCompare').addClass('hide');
	$("#setupInfos").hide("blind");
	$("#compareDemos").hide("blind");
	$("#loadSeeConfig").hide("blind");
}

function setupShow(){
	if (lastclicked == "setup"){
		$("#setupInfos").toggle("blind");
	}else{
		hideAll();
		lastclicked="setup";
		setupShow();
	}
}

function sendConfig(){
	hideAll();
	pathJar = $('#jarFile').val();
	nameConfigFile = $('#configName').val();
}

/* =============== COMPARE A LOADED CONFIGURATION WITH ONE OF THE DEMOS ================= */

// Manage the small window to choose the demo and launch
function showCompareUI(){
	if (lastclicked == "config"){
		$("#compareDemos").toggle("blind");
	}else{
		// We come from another menu item
		hideAll();
		lastclicked="config";
		$("#compareDemos").toggle("blind");
	}
	
	// Reset all colors and legend when the menu is reselected
	eraseColorRadio();
	$('#legendCompare').addClass('hide');
}




// Prep the data structure to compare the 2 files
function compareConfig(){
	// Hide the menu and show the legend
	$("#compareDemos").toggle("blind");
	$('#legendCompare').removeClass('hide');
	
	// Prepare 2 dictionnaries, one for the chosen demo
	// One for the user's loaded configuration
	var dictDemo = prepDemoDict();
	var dictUser = prepConfigDict();
	compareDict(dictDemo, dictUser);
}

/* Remove the values present in the 2 dict (similar to a set)
* The values left in dictDemo are categorized as 'missing'
* The values left in dictUser are categorized as 'extra' or 'incorrect' */
function compareDict(dictDemo, dictUser){
	for (var keyDemo in dictDemo){
		var valueDemo = dictDemo[keyDemo];
		
		// veh is an exception as it caused problems 
		// and this arg is present everywhere
		if (keyDemo == "veh"){
			continue;
		}
		
		for (var keyUser in dictUser){
			var valueUser = dictUser[keyUser];
			// We compare both the key and the value
			if (keyUser == keyDemo && valueUser == valueDemo){
				delete dictDemo[keyDemo];
				delete dictUser[keyUser];
			}
		}
	}
	
	// Calls the UI change on all the values not matched
	for (var keyDemo in dictDemo){
		changeColorRadio(keyDemo,dictDemo[keyDemo],'missing');
	}
	
	for (var keyUser in dictUser){
		changeColorRadio(keyUser,dictUser[keyUser],'incorrect');
	}
}

/* For a given name, find the label associated with the radio button
* Change it's color by associating the right class
* typeError is either 'incorrect' (extra) or 'missing' */
function changeColorRadio(radioName, value, typeError){
	$('label[name="title_'+radioName+'"]').each(function() {
			jQuery(this).addClass('titleNotice');
			jQuery(this).removeClass('normal');
	});
	$('label[for="'+radioName+'"]').each(function() {
		if (jQuery(this).text() == value){
			jQuery(this).addClass(typeError);
			jQuery(this).removeClass('normal');
		}
	});
}

/* =============== (END) ==== COMPARE A LOADED CONFIGURATION WITH ONE OF THE DEMOS ================= */

$(document).ready(function(){
				$.ajax({
					url: "./flags.txt",
					dataType: "text",
					success: function (data) {
							var args = preparedata(data);
							addRadioBool(args);
							loadMenuEvents();
					}   	
				});
});


</script>
</head>
<body>
<ul>
  <li class="shine"><a id="menuSetupConfig" href="">Setup environment</a></li>
  <li><a id="menuGenerateConfig" href="">Generate a configuration</a></li>
  <li><a id="menuLoadSeeConfig" href="">Load and see a configuration</a></li>
  <li><a id="menuCompareConfig" href="">Compare a configuration with demos</a></li>
  <li><a id="menuCallJavaApp" href="">Generate a GMF</a></li>
  <li style="float:right"><a class="active" href="about.html">About</a></li>
</ul>
<div id="loadSeeConfig" class="hide">
	<form class="leftSpace topSpace">
	Select a .launch config file
	</form>
	<input type="file" id="fileToLoad">
	<button id="btnLoadConfig" class="topMarg" onclick="triggerLoad()">Confirm</button>
</div>
<div id="setupInfos" class="hide">
<p> Step 1 : </p>
	<form class="leftSpace">
	<!--<input type="button" id="jarFileFakeBtn" onclick="document.getElementById('jarFile').click();" value="Give jar Location" />-->
	Download the <a href="#todo">jar</a>
	</form>
<p> Step 2 : </p>
	<form class="leftSpace">
	  Write the absolute path to the jar (This will be your working folder) : <br>
	  <input type="text" id="jarFile" size="35" value="E:\Ducky_Genie\canardrunnable.jar"><br>
	</form>
<p> Step 3 : </p>
	<form class="leftSpace">
	  Choose a name for the Config File : <br>
	  <input type="text" id="configName" value="myConfig"><br>
	</form>
	
	<button id="sendConfig" class="topMarg" onclick="sendConfig()">Confirm</button>
</div>
<div id="compareDemos" class="hide">
	<form class="leftSpace topSpace">
	Choose your desired demo file

	<select id="demo_files" class="leftSpace">
		<option value="indefinite_navigation">indefinite_navigation</option>
		<option value="intersection">intersection</option>
		<option value="joystick">joystick</option>
		<option value="lane_following">lane_following</option>
		<option value="localization">localization</option>
		<option value="localization_frontend">localization_frontend</option>
		<option value="localization_navigation">localization_navigation</option>
	</select>
	</form>
<button id="sendConfigCompare" class="topMarg" onclick="compareConfig()">Confirm</button>
</div>
<h1 id="title"> Prototype - Configuration Duckietown </h1>
<div id="space">
</div>

<div class="floatL">
	<div id="split3">
	<!--
		<div class="floatL">
			<div class="btn">
				<button id="btn_ros2java" onclick="rosToJava()">Launch -> Config</button>-->
				<a download="" id="downloadlinkjava" style="display: none">Download Java</a>
			<!--</div>
			<div class="btn">
				<button id="btn_java2ros" onclick="parsetoROS('Test')"> Config -> Launch</button>-->
				<a download="" id="downloadlinkros" style="display: none">Download ROS</a>
			<!--</div>
		</div> -->
		<!--
		<div class = "sameline">
				<div class ="btn floatL">
					<button id="btn_demos" onclick="compareConfig()">Compare config</button>
				</div>-->
				<div id="legendCompare" class="hide">
					<p class="titleNotice under">Flag is different</p>
					<p class="missing under">In demo, not in config</p>
					<p class="incorrect under">In config, not in demo</p>
				</div>
<!--
		</div>-->
		
	</div>
	<!--
	<div class="floatL">
		<caption> Load a launch configuration </caption>
		<input type="file" id="fileToLoad">
		<button onclick="fetchConfigFile()">Load Launch</button>
	</div>

	<div class="sameline">
		<div class="btn">
			<button id="btn_export" onclick="callJavaApp()"> Call Java </button>
		</div>
	</div>
	-->
	<!-- change the drop down list to dynamic, checks the files in the folder -->

</div>

</div>
</body>
</html>
