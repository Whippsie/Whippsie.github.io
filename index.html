<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="styles/style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="./scripts/files.js"></script>
<script src="./scripts/objects.js"></script>
<script src="./scripts/parsing.js"></script>
<script>
//TODO: Modify this into https://www.w3schools.com/tags/tag_fieldset.asp for better graphics
function getAllIndexes(arr, val) {
    var indexes = [], i;
    for(i = 0; i < arr.length; i++)
        if (arr[i] === val)
            indexes.push(i);
    return indexes;
}
function rosToJava(){
	if (dataUser==""){
		alert('Please load a launch file first');
	}else{
		var dictUser = rosToDict(dataUser);
		dictToJava(dictUser);
	}
}
function readFile (fullpath){
	var result="";
	$.ajax({
		url: fullpath,
		async: false,
		dataType: "text",
		success: function (data) {
			result = data;
		}
	});
	return result;
}

function compareConfig(){
	var dictDemo = prepDemoDict();
	var dictUser = prepConfigDict();
	compareDict(dictDemo, dictUser);
	$('#legend_titlenotice').toggleClass('hide');
	$('#legend_missing').toggleClass('hide');
	$('#legend_incorrect').toggleClass('hide');
}

function compareDict(dictDemo, dictUser){
	for (var keyDemo in dictDemo){
		var valueDemo = dictDemo[keyDemo];
		if (keyDemo == "veh"){
			continue;
		}
		for (var keyUser in dictUser){
			var valueUser = dictUser[keyUser];
			if (keyUser == keyDemo && valueUser == valueDemo){
				delete dictDemo[keyDemo];
				delete dictUser[keyUser];
			}
		}
	}
	
	//Those still in demo are missing from config
	for (var keyDemo in dictDemo){
		changeColorRadio(keyDemo,dictDemo[keyDemo],'missing');
	}
	//Those still in config are extra to demo
	for (var keyUser in dictUser){
		changeColorRadio(keyUser,dictUser[keyUser],'incorrect');
	}
}

//typeError is either incorrect (extra) or missing 
function changeColorRadio(radioName, value, typeError){
	$('label[name="title_'+radioName+'"]').each(function() {
			jQuery(this).addClass('titleNotice');
	});
	$('label[for="'+radioName+'"]').each(function() {
		var potato = "hi";
		if (jQuery(this).text() == value){
			var potato = "ho";
			jQuery(this).addClass(typeError);
		}
	});

}
function prepDemoDict(){
	var selected = $('#demo_files').val();
	var dataDemo = readFile("demos/"+selected+".launch");
	var dictDemo = rosToDict(dataDemo);
	return dictDemo;
}

function prepConfigDict(){
	//parsetoROS ('ConfigUser');
	//var dataUser = readFile("ConfigUser.launch");
	var dictUser = rosToDict(dataUser);
	return dictUser;
}
function fetchConfigFile(){
	loadFileAsText();
	alert('Launch file loaded');
}

function callJavaApp(){
	var url = '/call-java-app';
	console.log(url);
	var xmlHttp = new XMLHttpRequest();

	xmlHttp.onreadystatechange = function () {
		if (xmlHttp.readyState === 4) {
			var test = xmlHttp.responseText;
			console.log(test);
		}
	}
	xmlHttp.open("GET", url, true); // false for synchronous request
	xmlHttp.send();

}

$(document).ready(function(){
				$.ajax({
					url: "./flags.txt",
					dataType: "text",
					success: function (data) {
							var args = preparedata(data);
							addRadioBool(args);
							
					}   	
				});
});
</script>
</head>
<body>
<h1 id="title"> Prototype - Configuration Duckietown </h1>
<div id="space">
</div>

<div class="floatL">
	<div id="split3">
		<div class="floatL">
			<div class="btn">
				<button id="btn_ros2java" onclick="rosToJava()">Launch -> Config</button>
				<a download="" id="downloadlinkjava" style="display: none">Download Java</a>
			</div>
			<div class="btn">
				<button id="btn_java2ros" onclick="parsetoROS('Test')"> Config -> Launch</button>
				<a download="" id="downloadlinkros" style="display: none">Download ROS</a>
			</div>
		</div>
		<div class = "sameline">
				<div class ="btn floatL">
					<button id="btn_demos" onclick="compareConfig()">Compare config</button>
				</div>
				<div class ="sameline">
					<p id="legend_titlenotice" class="titleNotice under hide">Flag is different</p>
					<p id="legend_missing" class="missing under hide">In demo, not in config</p>
					<p id="legend_incorrect" class="incorrect under hide">In config, not in demo</p>
				</div>

		</div>
		<div class="sameline">
			<select id="demo_files" class="floatL">
			  <option value="indefinite_navigation">indefinite_navigation</option>
			  <option value="intersection">intersection</option>
			  <option value="joystick">joystick</option>
			  <option value="lane_following">lane_following</option>
			  <option value="localization">localization</option>
			  <option value="localization_frontend">localization_frontend</option>
			  <option value="localization_navigation">localization_navigation</option>
			</select>
		</div>
	</div>

	<div class="floatL">
		<input type="file" id="fileToLoad">
		<button onclick="fetchConfigFile()">Load Launch</button>
	</div>
	<div class="sameline">
		<div class="btn">
			<button id="btn_export" onclick="callJavaApp()"> Call Java </button>
		</div>
	</div>

	<!-- change the drop down list to dynamic, checks the files in the folder -->

</div>

</div>
</body>
</html>
